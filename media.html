<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Library - Smart Board Admin</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/theme.js"></script>
    <script src="js/header.js"></script>
    <link rel="icon" type="image/x-icon" href="logo/favicon.ico">
</head>

<body>
    <script src="js/auth.js"></script>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="logo/Ves.png" alt="VES Logo" class="logo-img">
                <span class="logo-text">Smart<span>Board</span></span>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <polyline points="9,22 9,12 15,12 15,22" />
                        </svg></span>
                    Dashboard
                </a>
                <a href="boards.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                            <line x1="8" y1="21" x2="16" y2="21" />
                            <line x1="12" y1="17" x2="12" y2="21" />
                        </svg></span>
                    Boards
                </a>
                <a href="create-notice.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <path d="M12 20h9" />
                            <path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z" />
                        </svg></span>
                    Create Notice
                </a>
                <a href="groups.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 00-3-3.87" />
                            <path d="M16 3.13a4 4 0 010 7.75" />
                        </svg></span>
                    Groups
                </a>
                <a href="schedules.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg></span>
                    Schedules
                </a>
                <a href="media.html" class="nav-item active">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <circle cx="8.5" cy="8.5" r="1.5" />
                            <polyline points="21,15 16,10 5,21" />
                        </svg></span>
                    Media Library
                </a>
                                <a href="templates.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="16" rx="2" />
                            <path d="M7 8h10" />
                            <path d="M7 12h10" />
                            <path d="M7 16h6" />
                        </svg></span>
                    Templates
                </a><a href="quotes.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <path d="M6 10h12" />
                            <path d="M6 14h8" />
                            <path d="M8 6h8" />
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                        </svg></span>
                    Quote Library
                </a>
                <a href="analytics.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <line x1="18" y1="20" x2="18" y2="10" />
                            <line x1="12" y1="20" x2="12" y2="4" />
                            <line x1="6" y1="20" x2="6" y2="14" />
                        </svg></span>
                    Analytics
                </a>
                <a href="audit-log.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" />
                            <path d="M12 6v6l4 2" />
                        </svg></span>
                    Audit Log
                </a>
                <a href="settings.html" class="nav-item">
                    <span class="nav-icon"><svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="3" />
                            <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V22a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H2a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33h.01a1.65 1.65 0 001-1.51V2a2 2 0 014 0v.09a1.65 1.65 0 001 1.51h.01a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.01a1.65 1.65 0 001.51 1H22a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z" />
                        </svg></span>
                    Settings
                </a>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main">
            <div class="page-header">
                <h1>Media Library</h1>
                <p>Upload and publish media files to smart boards</p>
            </div>

            <!-- Upload Section -->
            <div class="card">
                <h3 class="card-title mb-4">Upload Media</h3>

                <div class="grid-2">
                    <!-- File Upload -->
                    <div>
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('file').click()">
                            <div class="upload-zone-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                                    <polyline points="17,8 12,3 7,8" />
                                    <line x1="12" y1="3" x2="12" y2="15" />
                                </svg>
                            </div>
                            <h4>Click to Upload</h4>
                            <p>or drag and drop images/videos here</p>
                            <p><small>Supports: JPG, PNG, GIF, MP4, WebM</small></p>
                        </div>
                        <form id="uploadForm" style="display: none;">
                            <input type="file" id="file" accept="image/*,video/*">
                        </form>
                    </div>

                    <!-- URL -->
                    <div>
                        <h4 class="mb-4">Or Add External URL</h4>
                        <form id="urlForm">
                            <div class="form-group">
                                <label for="url">Media URL (YouTube, Google Drive, or direct link)</label>
                                <input type="url" id="url" placeholder="https://www.youtube.com/watch?v=...">
                                <small class="text-gray">Supports: YouTube, Google Drive, direct image/video URLs.
                                    If YouTube embed is blocked (153/150), use Google Drive preview or direct MP4/WebM.</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Add URL</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Media List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">All Media</h3>
                    <button class="btn btn-secondary btn-sm" onclick="loadMedia()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="23,4 23,10 17,10" />
                            <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10" />
                        </svg>
                        Refresh
                    </button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Preview</th>
                                <th>Type</th>
                                <th>Path/URL</th>
                                <th>Uploaded</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mediaTable">
                            <tr>
                                <td colspan="6">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Media Scheduling</h3>
                    <button class="btn btn-secondary btn-sm" onclick="loadMediaSchedules()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="23,4 23,10 17,10" />
                            <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10" />
                        </svg>
                        Refresh
                    </button>
                </div>

                <div class="grid-3 mb-4">
                    <div class="stat-card">
                        <small class="text-gray">Currently Playing</small>
                        <h4 id="currentMediaSchedule">None</h4>
                    </div>
                    <div class="stat-card">
                        <small class="text-gray">Upcoming</small>
                        <h4 id="upcomingMediaCount">0</h4>
                    </div>
                    <div class="stat-card">
                        <small class="text-gray">Expired</small>
                        <h4 id="expiredMediaCount">0</h4>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Boards</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mediaSchedulesTable">
                            <tr>
                                <td colspan="6">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Publish Modal -->
    <div class="modal-overlay" id="publishModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Publish Media to Boards</h3>
                <button class="modal-close" onclick="closePublishModal()">&times;</button>
            </div>

            <div id="publishPreview" class="mb-4 text-center">
                <!-- Preview will be inserted here -->
            </div>

            <form id="publishForm">
                <div class="form-group">
                    <label>Select Target Boards</label>
                    <div class="board-select-grid" id="publishBoardsList">
                        <!-- Boards will be loaded here -->
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="selectAllBoards" onchange="toggleAllBoards()">
                        Select All Boards
                    </label>
                </div>

                <!-- Schedule Section -->
                <div class="form-group">
                    <label style="font-weight: 600;">Overall Active Window *</label>
                    <small class="text-gray">Set the main start/end date-time range for this media schedule.</small>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="publishStartTime">Start Date & Time *</label>
                        <input type="datetime-local" id="publishStartTime" required>
                        <small class="text-gray">Media will start showing at this time</small>
                    </div>
                    <div class="form-group">
                        <label for="publishEndTime">End Date & Time *</label>
                        <input type="datetime-local" id="publishEndTime" required>
                        <small class="text-gray">Media will stop showing at this time</small>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label style="display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" id="publishRecurring" onchange="toggleMediaRecurring()">
                        Enable Daily Recurring Schedule
                    </label>
                    <small class="text-gray">Use this when you want a date range + daily time window + selected weekdays.</small>
                </div>

                <div id="mediaRecurringOptions"
                    style="display:none; margin-top: 0.5rem; padding:1rem; border:1px solid var(--gray-light); border-radius:8px;">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="publishRecurringStartDate">Recurring From Date *</label>
                            <input type="date" id="publishRecurringStartDate">
                            <small class="text-gray">First date for recurring playback</small>
                        </div>
                        <div class="form-group">
                            <label for="publishRecurringEndDate">Recurring To Date *</label>
                            <input type="date" id="publishRecurringEndDate">
                            <small class="text-gray">Last date for recurring playback</small>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="publishDailyStartTime">Daily Start Time *</label>
                            <input type="time" id="publishDailyStartTime" value="09:00">
                        </div>
                        <div class="form-group">
                            <label for="publishDailyEndTime">Daily End Time *</label>
                            <input type="time" id="publishDailyEndTime" value="17:00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Days of Week</label>
                        <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
                            <label><input type="checkbox" name="mediaRecurDays" value="0"> Sun</label>
                            <label><input type="checkbox" name="mediaRecurDays" value="1" checked> Mon</label>
                            <label><input type="checkbox" name="mediaRecurDays" value="2" checked> Tue</label>
                            <label><input type="checkbox" name="mediaRecurDays" value="3" checked> Wed</label>
                            <label><input type="checkbox" name="mediaRecurDays" value="4" checked> Thu</label>
                            <label><input type="checkbox" name="mediaRecurDays" value="5" checked> Fri</label>
                            <label><input type="checkbox" name="mediaRecurDays" value="6"> Sat</label>
                        </div>
                        <small class="text-gray">Media plays only on selected weekdays within the recurring date range.</small>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePublishModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M22 2L11 13" />
                            <path d="M22 2l-7 20-4-9-9-4 20-7z" />
                        </svg>
                        Schedule & Publish
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/config.js?v=20260211"></script>
    <script src="js/api.js"></script>
        <script>
        let allBoards = [];
        let selectedMediaForPublish = null;
        let mediaSchedules = [];

        function esc(value) {
            if (typeof window.escapeHtml === 'function') return window.escapeHtml(value);
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function normalizeScheduleState(value) {
            const state = String(value || '').trim().toLowerCase();
            if (['active', 'scheduled', 'inactive', 'expired'].includes(state)) return state;
            return 'scheduled';
        }

        function safeId(value) {
            return String(value || '').replace(/[^A-Za-z0-9_-]/g, '');
        }

        function safeUrl(value) {
            const raw = String(value || '').trim();
            if (!raw) return '';
            const candidate = raw.startsWith('/') ? `${config.SERVER_URL}${raw}` : raw;
            try {
                const parsed = new URL(candidate);
                if (!['http:', 'https:'].includes(parsed.protocol)) return '';
                if (parsed.username || parsed.password) return '';
                return parsed.toString();
            } catch (error) {
                return '';
            }
        }

        connectWebSocket();
        addWSListener((data) => {
            if (!data || !data.type) return;
            if (data.type.includes('notice')) {
                loadMediaSchedules();
            }
            if (data.type.includes('media')) {
                loadMedia();
            }
        });

        function extractYouTubeId(url) {
            try {
                const parsed = new URL(url);
                const host = parsed.hostname.toLowerCase();

                if (host.includes('youtu.be')) {
                    const shortId = parsed.pathname.split('/').filter(Boolean)[0];
                    if (shortId && shortId.length === 11) return shortId;
                }

                if (host.includes('youtube.com')) {
                    const queryId = parsed.searchParams.get('v');
                    if (queryId && queryId.length === 11) return queryId;

                    const segments = parsed.pathname.split('/').filter(Boolean);
                    if (segments.length >= 2 && ['embed', 'v', 'shorts', 'live'].includes(segments[0])) {
                        const pathId = segments[1];
                        if (pathId && pathId.length === 11) return pathId;
                    }
                }
            } catch (error) {
                // Ignore URL parser errors and fall back to regex.
            }

            const match = String(url).match(/(?:youtube\.com\/(?:watch\?.*v=|embed\/|v\/|shorts\/|live\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : '';
        }

        function getSelectedMediaRecurringDays() {
            const checked = document.querySelectorAll('input[name="mediaRecurDays"]:checked');
            return Array.from(checked).map((cb) => cb.value).join(',');
        }

        function combineLocalDateTime(dateValue, timeValue) {
            if (!dateValue || !timeValue) return '';
            return `${dateValue}T${timeValue}`;
        }

        function syncMediaWindowFromRecurring() {
            const recurring = document.getElementById('publishRecurring').checked;
            if (!recurring) return;

            const recurringStartDate = document.getElementById('publishRecurringStartDate').value;
            const recurringEndDate = document.getElementById('publishRecurringEndDate').value;
            const dailyStart = document.getElementById('publishDailyStartTime').value;
            const dailyEnd = document.getElementById('publishDailyEndTime').value;

            const syncedStart = combineLocalDateTime(recurringStartDate, dailyStart);
            const syncedEnd = combineLocalDateTime(recurringEndDate, dailyEnd);

            if (syncedStart) {
                document.getElementById('publishStartTime').value = syncedStart;
            }
            if (syncedEnd) {
                document.getElementById('publishEndTime').value = syncedEnd;
            }
        }

        function toggleMediaRecurring() {
            const recurring = document.getElementById('publishRecurring').checked;
            document.getElementById('mediaRecurringOptions').style.display = recurring ? 'block' : 'none';

            if (recurring) {
                const startTime = document.getElementById('publishStartTime').value;
                const endTime = document.getElementById('publishEndTime').value;
                const recurringStartInput = document.getElementById('publishRecurringStartDate');
                const recurringEndInput = document.getElementById('publishRecurringEndDate');

                if (!recurringStartInput.value && startTime) {
                    recurringStartInput.value = startTime.slice(0, 10);
                }
                if (!recurringEndInput.value && endTime) {
                    recurringEndInput.value = endTime.slice(0, 10);
                }
                syncMediaWindowFromRecurring();
            }
        }

        async function loadMedia() {
            try {
                const result = await api.get('/media');
                const media = result.media || [];
                const tbody = document.getElementById('mediaTable');

                if (media.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21,15 16,10 5,21"/>
                                    </svg>
                                </div>
                                <p>No media files yet. Upload your first file above!</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = media.map((m) => {
                    const mediaTypeRaw = String(m.type || '').toLowerCase();
                    const mediaPath = String(m.pathOrUrl || '');
                    const isImage = mediaTypeRaw === 'image' || mediaPath.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i);
                    const isVideo = mediaTypeRaw === 'video' || mediaPath.match(/\.(mp4|webm|ogg|mov|mkv)(\?.*)?$/i);
                    const isYouTube = mediaTypeRaw === 'youtube' || mediaPath.includes('youtube.com') || mediaPath.includes('youtu.be');
                    const fullUrl = safeUrl(mediaPath) || '#';

                    let youtubeThumb = '';
                    if (isYouTube) {
                        const ytId = extractYouTubeId(mediaPath);
                        if (ytId) {
                            youtubeThumb = `https://img.youtube.com/vi/${ytId}/mqdefault.jpg`;
                        }
                    }

                    let previewHtml = '';
                    if (isYouTube && youtubeThumb) {
                        previewHtml = `<div class="media-preview" style="position:relative;display:flex;align-items:center;justify-content:center;">
                            <img src="${esc(youtubeThumb)}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" alt="YouTube">
                            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:30px;height:30px;background:rgba(255,0,0,0.85);border-radius:6px;display:flex;align-items:center;justify-content:center;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="white"><polygon points="9.5,7.5 16.5,12 9.5,16.5"/></svg>
                            </div>
                        </div>`;
                    } else if (isImage) {
                        previewHtml = `<img src="${esc(fullUrl)}" class="media-preview" alt="Preview">`;
                    } else if (isVideo) {
                        previewHtml = `<video src="${esc(fullUrl)}" class="media-preview" muted></video>`;
                    } else {
                        previewHtml = `<div class="media-preview" style="display:flex;align-items:center;justify-content:center;">URL</div>`;
                    }

                    const encodedUrl = encodeURIComponent(fullUrl);
                    const encodedType = encodeURIComponent(mediaTypeRaw || 'file');
                    const safeMediaId = safeId(m.mediaId);
                    const displayPath = mediaPath.length > 40 ? `${mediaPath.substring(0, 40)}...` : mediaPath;

                    return `
                        <tr>
                            <td>${previewHtml}</td>
                            <td><span class="badge badge-${isYouTube ? 'warning' : 'normal'}">${esc(isYouTube ? 'youtube' : (m.type || 'file'))}</span></td>
                            <td>
                                <a href="${esc(fullUrl)}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); word-break: break-all; font-size: 0.85rem;">
                                    ${esc(displayPath)}
                                </a>
                            </td>
                            <td style="font-size: 0.85rem;">${esc(formatDate(m.uploadedAt))}</td>
                            <td>
                                <span class="publish-status unpublished">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                    </svg>
                                    Ready
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-success btn-sm" onclick="openPublishModal('${safeMediaId}', '${encodedUrl}', '${encodedType}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/>
                                        </svg>
                                        Publish
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteMedia('${safeMediaId}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Load media error:', error);
                showToast('Failed to load media', 'error');
            }
        }

        async function loadMediaSchedules() {
            try {
                const result = await api.get('/schedules?moduleType=media');
                mediaSchedules = result.schedules || [];
                renderMediaSchedules();
            } catch (error) {
                console.error('Load media schedules error:', error);
                showToast('Failed to load media schedules', 'error');
            }
        }

        function renderMediaSchedules() {
            const tbody = document.getElementById('mediaSchedulesTable');
            const currentItem = mediaSchedules.find((schedule) => schedule.state === 'active');
            const upcoming = mediaSchedules.filter((schedule) => schedule.state === 'scheduled');
            const expired = mediaSchedules.filter((schedule) => schedule.state === 'expired');

            document.getElementById('currentMediaSchedule').textContent = currentItem ? currentItem.title : 'None';
            document.getElementById('upcomingMediaCount').textContent = String(upcoming.length);
            document.getElementById('expiredMediaCount').textContent = String(expired.length);

            if (mediaSchedules.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <p>No media schedules yet.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = mediaSchedules.map((schedule) => {
                const targets = schedule.targetBoards === 'all'
                    ? 'All Boards'
                    : `${(schedule.targetBoards || '').split('|').filter(Boolean).length} board(s)`;
                const enabled = String(schedule.enabled) === 'true' || schedule.enabled === true;
                const toggleLabel = enabled ? 'Disable' : 'Enable';
                const toggleClass = enabled ? 'btn-secondary' : 'btn-success';
                const safeScheduleId = safeId(schedule.scheduleId);
                const status = normalizeScheduleState(schedule.state);

                return `
                    <tr>
                        <td><strong>${esc(schedule.title || 'Media Schedule')}</strong></td>
                        <td>${esc(targets)}</td>
                        <td>${esc(formatDate(schedule.startTime))}</td>
                        <td>${esc(formatDate(schedule.endTime))}</td>
                        <td><span class="badge badge-${status}">${esc(status)}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn ${toggleClass} btn-sm" onclick="toggleMediaSchedule('${safeScheduleId}', ${enabled ? 'false' : 'true'})">${esc(toggleLabel)}</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteMediaSchedule('${safeScheduleId}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function toggleMediaSchedule(scheduleId, enable) {
            try {
                const result = await api.patch(`/schedules/${scheduleId}/toggle`, { enabled: enable });
                if (result.success) {
                    showToast(enable ? 'Media schedule enabled' : 'Media schedule disabled');
                    loadMediaSchedules();
                } else {
                    showToast(result.error || 'Failed to update media schedule', 'error');
                }
            } catch (error) {
                showToast('Failed to update media schedule', 'error');
            }
        }

        async function deleteMediaSchedule(scheduleId) {
            if (!confirm('Delete this media schedule?')) return;

            try {
                const result = await api.delete(`/schedules/${scheduleId}`);
                if (result.success) {
                    showToast('Media schedule deleted');
                    loadMediaSchedules();
                } else {
                    showToast(result.error || 'Failed to delete media schedule', 'error');
                }
            } catch (error) {
                showToast('Failed to delete media schedule', 'error');
            }
        }

        async function loadBoards() {
            try {
                const result = await api.get('/boards');
                allBoards = result.boards || [];
            } catch (error) {
                console.error('Load boards error:', error);
            }
        }

        function openPublishModal(mediaId, encodedUrl, encodedType) {
            const url = decodeURIComponent(String(encodedUrl || ''));
            const type = decodeURIComponent(String(encodedType || ''));
            selectedMediaForPublish = { mediaId: safeId(mediaId), url, type };

            const preview = document.getElementById('publishPreview');
            preview.replaceChildren();

            const ytId = extractYouTubeId(url);
            const resolvedUrl = safeUrl(url);
            if (ytId || type === 'youtube') {
                if (ytId) {
                    const iframe = document.createElement('iframe');
                    iframe.src = `https://www.youtube.com/embed/${ytId}?autoplay=0&rel=0`;
                    iframe.className = 'media-preview-lg';
                    iframe.style.width = '100%';
                    iframe.style.height = '300px';
                    iframe.style.border = 'none';
                    iframe.style.borderRadius = '8px';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                    iframe.allowFullscreen = true;
                    preview.appendChild(iframe);
                } else {
                    const fallback = document.createElement('div');
                    fallback.style.padding = '2rem';
                    fallback.style.textAlign = 'center';
                    fallback.style.background = '#1f2937';
                    fallback.style.borderRadius = '8px';
                    const label = document.createElement('p');
                    label.style.color = '#aaa';
                    label.style.marginTop = '0.5rem';
                    label.textContent = 'YouTube Video';
                    fallback.appendChild(label);
                    preview.appendChild(fallback);
                }
            } else if (type === 'video' || url.match(/\.(mp4|webm|ogg|mov|mkv)(\?.*)?$/i)) {
                const video = document.createElement('video');
                video.className = 'media-preview-lg';
                video.controls = true;
                video.src = resolvedUrl;
                preview.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.className = 'media-preview-lg';
                img.alt = 'Preview';
                img.src = resolvedUrl;
                preview.appendChild(img);
            }

            const boardsList = document.getElementById('publishBoardsList');
            if (allBoards.length === 0) {
                boardsList.innerHTML = '<p class="text-gray">No boards registered yet.</p>';
            } else {
                boardsList.innerHTML = allBoards.map((board) => `
                    <label class="board-checkbox">
                        <input type="checkbox" name="boards" value="${esc(board.boardId)}">
                        <div>
                            <strong>${esc(board.boardId)}</strong>
                            <small style="display:block;color:var(--gray);">Room: ${esc(board.roomNumber)}</small>
                        </div>
                    </label>
                `).join('');
            }

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const oneHourLater = new Date(now.getTime() + (60 * 60 * 1000));

            document.getElementById('publishStartTime').value = now.toISOString().slice(0, 16);
            document.getElementById('publishEndTime').value = oneHourLater.toISOString().slice(0, 16);
            document.getElementById('selectAllBoards').checked = false;
            document.getElementById('publishRecurring').checked = false;
            document.getElementById('publishRecurringStartDate').value = now.toISOString().slice(0, 10);
            document.getElementById('publishRecurringEndDate').value = oneHourLater.toISOString().slice(0, 10);
            document.getElementById('publishDailyStartTime').value = '09:00';
            document.getElementById('publishDailyEndTime').value = '17:00';
            document.querySelectorAll('input[name="mediaRecurDays"]').forEach((cb) => {
                cb.checked = ['1', '2', '3', '4', '5'].includes(cb.value);
            });
            toggleMediaRecurring();

            document.getElementById('publishModal').classList.add('show');
        }

        function closePublishModal() {
            document.getElementById('publishModal').classList.remove('show');
            selectedMediaForPublish = null;
        }

        function toggleAllBoards() {
            const checked = document.getElementById('selectAllBoards').checked;
            document.querySelectorAll('input[name="boards"]').forEach((cb) => {
                cb.checked = checked;
                cb.closest('.board-checkbox').classList.toggle('selected', checked);
            });
        }

        document.addEventListener('change', (event) => {
            if (event.target.name === 'boards') {
                event.target.closest('.board-checkbox').classList.toggle('selected', event.target.checked);
            }
        });

        document.getElementById('publishForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedMediaForPublish) return;

            const selectedBoards = Array.from(document.querySelectorAll('input[name="boards"]:checked')).map((cb) => cb.value);
            if (selectedBoards.length === 0) {
                showToast('Please select at least one board', 'error');
                return;
            }

            const startTimeInput = document.getElementById('publishStartTime').value;
            const endTimeInput = document.getElementById('publishEndTime').value;
            const recurring = document.getElementById('publishRecurring').checked;
            const recurringStartDate = document.getElementById('publishRecurringStartDate').value;
            const recurringEndDate = document.getElementById('publishRecurringEndDate').value;
            const dailyStart = document.getElementById('publishDailyStartTime').value;
            const dailyEnd = document.getElementById('publishDailyEndTime').value;
            const recurringDays = getSelectedMediaRecurringDays();
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || '';

            let effectiveStartTime = startTimeInput;
            let effectiveEndTime = endTimeInput;

            if (recurring) {
                if (!recurringStartDate || !recurringEndDate) {
                    showToast('Please select recurring from and to dates', 'error');
                    return;
                }
                if (new Date(recurringEndDate) < new Date(recurringStartDate)) {
                    showToast('Recurring To Date must be on or after From Date', 'error');
                    return;
                }
                if (!dailyStart || !dailyEnd) {
                    showToast('Please set daily start and end time', 'error');
                    return;
                }
                if (!recurringDays) {
                    showToast('Please select at least one recurring day', 'error');
                    return;
                }

                effectiveStartTime = combineLocalDateTime(recurringStartDate, dailyStart);
                effectiveEndTime = combineLocalDateTime(recurringEndDate, dailyEnd);
                document.getElementById('publishStartTime').value = effectiveStartTime;
                document.getElementById('publishEndTime').value = effectiveEndTime;
            }

            if (!effectiveStartTime || !effectiveEndTime) {
                showToast('Please select start and end time', 'error');
                return;
            }

            if (new Date(effectiveEndTime) <= new Date(effectiveStartTime)) {
                showToast('End time must be after start time', 'error');
                return;
            }

            try {
                const result = await api.post('/notice/create', {
                    title: 'Media Schedule',
                    content: 'Displaying scheduled media',
                    priority: 'normal',
                    startTime: new Date(effectiveStartTime).toISOString(),
                    endTime: new Date(effectiveEndTime).toISOString(),
                    targetBoards: selectedBoards,
                    mediaUrl: selectedMediaForPublish.url,
                    mediaType: selectedMediaForPublish.type,
                    moduleType: 'media',
                    isRecurring: recurring,
                    dailyStartTime: recurring ? dailyStart : '',
                    dailyEndTime: recurring ? dailyEnd : '',
                    recurringDays: recurring ? recurringDays : '',
                    timezone
                });

                if (result.success) {
                    const startTime = new Date(effectiveStartTime);
                    const isNow = startTime <= new Date();
                    showToast(isNow ? 'Media published now!' : `Media scheduled for ${startTime.toLocaleString()}`, 'success');
                    closePublishModal();
                    loadMediaSchedules();
                } else {
                    showToast(result.error || 'Failed to publish', 'error');
                }
            } catch (error) {
                console.error('Publish error:', error);
                showToast('Failed to publish media', 'error');
            }
        });

        async function deleteMedia(mediaId) {
            if (!confirm('Delete this media?')) return;

            try {
                const result = await api.delete(`/media/${mediaId}`);
                if (result.success) {
                    showToast('Media deleted');
                    loadMedia();
                } else {
                    showToast(result.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                showToast('Failed to delete', 'error');
            }
        }

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('file');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                uploadFile(e.target.files[0]);
            }
        });

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showToast('Uploading...');
                const result = await api.upload('/media/upload', formData);
                if (result.success) {
                    showToast('File uploaded successfully!', 'success');
                    fileInput.value = '';
                    loadMedia();
                } else {
                    showToast(result.error || 'Upload failed', 'error');
                }
            } catch (error) {
                showToast('Upload failed', 'error');
            }
        }

        document.getElementById('urlForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('url').value.trim();
            if (!url) {
                showToast('Please enter a URL', 'error');
                return;
            }

            try {
                const result = await api.post('/media/url', { url });
                if (result.success) {
                    showToast('URL added successfully!', 'success');
                    document.getElementById('url').value = '';
                    loadMedia();
                } else {
                    showToast(result.error || 'Failed to add URL', 'error');
                }
            } catch (error) {
                showToast('Failed to add URL', 'error');
            }
        });

        loadMedia();
        loadBoards();
        loadMediaSchedules();

        ['publishRecurringStartDate', 'publishRecurringEndDate', 'publishDailyStartTime', 'publishDailyEndTime'].forEach((id) => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', syncMediaWindowFromRecurring);
            }
        });
    </script>
</body>

</html>


